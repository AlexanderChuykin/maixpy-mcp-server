# Архитектура MaixPy MCP Server

## Схема работы

```
┌─────────────────────────────────────────────────────────────┐
│                        VS Code                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              GitHub Copilot Chat                     │   │
│  │                                                       │   │
│  │  Пользователь: "@workspace Как использовать камеру?" │   │
│  └───────────────────────┬─────────────────────────────┘   │
│                          │                                   │
└──────────────────────────┼───────────────────────────────────┘
                           │
                           │ MCP Protocol (JSON-RPC over stdio)
                           │
┌──────────────────────────▼───────────────────────────────────┐
│                  MCP Server (Python)                          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │           MaixPyDocServer Class                        │  │
│  │                                                         │  │
│  │  Tools:                                                │  │
│  │  ├─ search_docs()          - Поиск по документации    │  │
│  │  ├─ get_api_reference()    - API модуля               │  │
│  │  ├─ list_modules()         - Список модулей           │  │
│  │  ├─ get_tutorial()         - Учебные пособия          │  │
│  │  └─ read_doc_file()        - Чтение файла             │  │
│  │                                                         │  │
│  └─────────────────────┬───────────────────────────────────┘  │
│                        │                                       │
└────────────────────────┼───────────────────────────────────────┘
                         │
                         │ File System Access
                         │
┌────────────────────────▼───────────────────────────────────────┐
│                   doc_md/ (Документация)                        │
│  ┌─────────────────┐  ┌──────────────────┐                    │
│  │   api/maix/     │  │    doc/en/       │                    │
│  │                 │  │                  │                    │
│  │  camera.md      │  │  vision/         │                    │
│  │  image.md       │  │  basic/          │                    │
│  │  display.md     │  │  audio/          │                    │
│  │  nn.md          │  │  network/        │                    │
│  │  ...            │  │  ...             │                    │
│  └─────────────────┘  └──────────────────┘                    │
└─────────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Запрос пользователя
```
Пользователь вводит в Copilot Chat:
"@workspace Как использовать камеру в MaixPy?"
```

### 2. Обработка Copilot
```
Copilot анализирует запрос и решает использовать MCP сервер.
Формирует запрос к инструменту search_docs:
{
  "tool": "search_docs",
  "arguments": {
    "query": "camera",
    "section": "all"
  }
}
```

### 3. Работа MCP сервера
```python
# Сервер получает запрос через stdio
async def call_tool(name: str, arguments: dict):
    if name == "search_docs":
        result = await self._search_docs(
            query="camera",
            section="all"
        )
    # Возвращает найденные файлы и содержимое
    return [TextContent(type="text", text=result)]
```

### 4. Поиск в документации
```python
# Сканирование файлов
for md_file in doc_root.rglob("*.md"):
    # Проверка имени файла
    if "camera" in md_file.stem.lower():
        results.append(file_info)
    
    # Поиск в содержимом
    content = md_file.read_text()
    if "camera" in content.lower():
        results.append(match_info)
```

### 5. Возврат результата
```
Сервер возвращает:
- Список найденных файлов
- Релевантные фрагменты
- Пути к полной документации
```

### 6. Ответ Copilot
```
Copilot получает данные от MCP сервера и формирует
человекопонятный ответ с примерами кода и ссылками
на документацию.
```

## Протокол MCP

### Инициализация
```json
{
  "jsonrpc": "2.0",
  "method": "initialize",
  "params": {
    "protocolVersion": "2024-11-05",
    "capabilities": {},
    "clientInfo": {
      "name": "vscode-copilot",
      "version": "1.0.0"
    }
  }
}
```

### Запрос списка инструментов
```json
{
  "jsonrpc": "2.0",
  "method": "tools/list",
  "id": 1
}
```

### Ответ с инструментами
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "tools": [
      {
        "name": "search_docs",
        "description": "Поиск по документации MaixPy...",
        "inputSchema": {
          "type": "object",
          "properties": {
            "query": {"type": "string"},
            "section": {"type": "string"}
          }
        }
      }
    ]
  }
}
```

### Вызов инструмента
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "search_docs",
    "arguments": {
      "query": "camera",
      "section": "api"
    }
  },
  "id": 2
}
```

### Ответ инструмента
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "Найдено результатов: 5\n\n1. api/maix/camera.md..."
      }
    ]
  }
}
```

## Компоненты системы

### 1. Client (VS Code + Copilot)
- Интерфейс пользователя
- Отправка запросов к MCP серверу
- Отображение результатов

### 2. MCP Server (Python)
- Обработка запросов через stdio
- Реализация инструментов
- Доступ к файловой системе

### 3. Documentation (doc_md/)
- Markdown файлы
- Структурированная документация
- API справочники и туториалы

## Преимущества архитектуры

✅ **Разделение ответственности** - каждый компонент решает свою задачу
✅ **Стандартный протокол** - использует MCP (широкая поддержка)
✅ **Расширяемость** - легко добавить новые инструменты
✅ **Независимость** - сервер работает отдельно от VS Code
✅ **Асинхронность** - эффективная обработка запросов

## Производительность

### Типичное время отклика
- **list_modules**: ~50ms (сканирование директорий)
- **search_docs**: ~200-500ms (поиск по файлам)
- **get_api_reference**: ~100ms (чтение одного файла)
- **read_doc_file**: ~50ms (прямое чтение)

### Оптимизации
- Ограничение результатов поиска (10 записей)
- Кеширование путей к файлам
- Асинхронная обработка

## Безопасность

✅ **Только чтение** - сервер не модифицирует файлы
✅ **Локальный доступ** - работает только с локальными файлами
✅ **Валидация путей** - проверка относительных путей
✅ **Обработка ошибок** - защита от некорректных входных данных
